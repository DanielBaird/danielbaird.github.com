<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html"/>
<title>Parasite Hatching Calculator</title>
<link rel="shortcut icon" href="favicon.ico" type="image/x-icon"/>
<style>
    html, body { padding: 1em 3em; margin: 0; font-family: sans-serif; }
    #form .form-element {
        padding: 0.5em 0;
    }
    #form .form-element label {
        display: inline-block;
        width: 8em;
        text-align: right;
        padding: 0.1em 1em;
    }
    #form .form-element input {
        font-size: inherit;
        font-family: inherit;
        padding: 0.1em 0.5em;
        margin: 0 0.5em;
        width: 6em;
    }
    #form .form-element .var-note {
        font-size: 90%;
        color: #930;
        display: inline-block;
        padding: 0.1em 0.5em;
    }
    .debug {
        font-family: monospace;
        font-size: 90%;
        line-height: 1.0;
    }
    .debug.show button, .debug.hide table { display: none; }
    .debug table {
        margin-bottom: 4em;
    }
    .debug td, .debug th {
        text-align: right;
        padding: 0 0.5em;
        margin: 0;
    }
</style>
</head>
<body>

<div id="form"></div>
<div id="result"></div>

<p>See <a href="http://www.jcu.edu.au/mtb/research/projects/JCU_083894.html">this project</a> for more info.</p>

<!-- decent folk put their javascript at the bottom -->
<!-- <script src="{{ site.baseurl }}assets/js/jquery-1.8.2.min.js"></script> -->
<script>
    var sq = function(x) { return Math.pow(x,2); }
    var cu = function(x) { return Math.pow(x,3); }
    var p4 = function(x) { return Math.pow(x,4); }
    var pow = function(x,y) { return Math.pow(x,y); }
    var elemId = function(id) { return document.getElementById(id); }
    var data = {
        // - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
        vars: [{
            name: 'salinity', abbr: 'ss',
            units: '&#x2030;',
            defaultVal: 35,
            warnMin: 22, warnMax: 40,
            warnMsg: 'Entered salinity value is outside the range for this model (22 - 40 &#x2030;). Use results with caution.',
            failMin: 15, failMax: 45,
            failMsg: 'Entered salinity value is unreasonable.'
        },{
            name: 'temperature', abbr: 'tt',
            units: '&#x2103;',
            defaultVal: 26,
            warnMin: 22, warnMax: 34,
            warnMsg: 'Entered temperature value is outside the range for this model (22 - 34 &#x2103;).  Use results with caution.',
            failMin: 16, failMax: 40,
            failMsg: 'Entered temperature value is unreasonable.'
        }],
        // - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
        calcs: [{
                name: 'hatching success', abbr: 'hatchrate', units: '%',
                rounding: 1, lowcap: 5, highcap: 95,
                terms: [
                    '1',
                    'tt',
                    'ss',
                    'tt * ss',
                    'sq(tt)',
                    'sq(ss)',
                    'tt * sq(ss)',
                    'sq(tt) * ss',
                    'sq(tt) * sq(ss)'
                ], coefficients: [
                    -5.016,
                     2.891e-01,
                     2.120e+01,
                    -1.633,
                    -4.862e-03,
                    -1.207,
                     9.572e-02,
                     2.983e-02,
                    -1.761e-03
            ]},{ // - - - - - - - - - - - - - - - - - - - - - - - - -
                name: 'infection success', abbr: 'infectrate', units: '%',
                rounding: 1, lowcap: 5, highcap: 95,
                terms: [
                    '1',
                    'tt',
                    'ss',
                    'tt * ss',
                    'sq(tt)',
                    'sq(ss)',
                    'sq(tt) * sq(ss)',
                    'cu(tt)',
                    'p4(tt)'
                ], coefficients: [
                     1.66e+04,
                    -2.292e+03,
                    -1.184e+01,
                     5.388e-01,
                     1.172e+02,
                     1.796e-01,
                    -2.258e-04,
                    -2.637,
                     2.198e-02
            ]},{ // - - - - - - - - - - - - - - - - - - - - - - - - -
                name: 'time to last hatch', abbr: 'hatchtime', units: 'days',
                rounding: 1, lowcap: 4, highcap: 10,
                terms: [
                    '1',
                    'tt',
                    'ss',
                    'tt * ss',
                    'sq(tt)',
                    'sq(ss)',
                    'tt * sq(ss)',
                    'sq(tt) * ss',
                    'cu(tt)',
                    'cu(ss)',
                    'cu(tt) * sq(ss)',
                    'sq(tt) * cu(ss)',
                    'p4(tt)',
                    'p4(ss)',
                    'p4(tt) * ss',
                    'tt * p4(ss)',
                    'p4(tt) * p4(ss)'
                ], coefficients: [
                     3.218e+02,
                    -4.574e+01,
                     1.839e+01,
                    -1.632,
                     2.403,
                    -2.120e-01,
                     1.073e-02,
                     3.975e-02,
                    -5.527e-02,
                     2.823e-03,
                    -2.436e-06,
                    -4.647e-06,
                     4.702e-04,
                    -4.473e-05,
                    -6.875e-06,
                     1.173e-06,
                     2.965e-11
            ]},{ // - - - - - - - - - - - - - - - - - - - - - - - - -
                name: 'time to earliest sexual maturity', abbr: 'maturity', units: 'days',
                rounding: 0, lowcap: 5, highcap: 14,
                terms: [
                    '1',
                    'tt',
                    'ss',
                    'tt * ss',
                    'sq(tt) * sq(ss)',
                    'cu(tt)',
                    'cu(ss)',
                    'pow(tt,ss)'
                ], coefficients: [
                     4.906e+01,
                    -1.419,
                    -3.488e-03,
                    -2.280e-02,
                     9.246e-06,
                     5.845e-04,
                     4.619e-06,
                    -8.897e-62
            ]}
        ]
        // - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
    };

    // for now just push form content and output into the body tag
    var form = elemId('form');
    var output = elemId('result');
    // --------------------------------------------------------------
    var buildForm = function() {
        var html = '';
        data.vars.forEach( function(theVar) {
            html += '<div class="form-element">';
            html += '<label for="var-' + theVar.abbr + '">' + theVar.name + '</label>';
            html += '<input type="number" ' +
                    'id="var-' + theVar.abbr + '" ' +
                    'name="var-' + theVar.abbr + '" ' +
                    'value="' + theVar.defaultVal + '" ' +
                    'onkeyup="calculate();" ' +
                    'onchange="calculate();"/>'
            html += theVar.units;
            html += '<span class="var-note" id="var-note-' + theVar.abbr + '"></span>';
            html += '</div>';
        });
        /*
        html += '<div class="form-element">';
        html += '<label></label>';
        html += '<input type="submit" onclick="calculate(); return false;" value="calculate">';
        html += '</div>';
        */
        form.innerHTML += html;
        calculate();
    }
    // --------------------------------------------------------------
    var getInputs = function() {
        // collect inputs and check them for validity
        varValues = {};
        valuesOkay = true;
        data.vars.forEach( function(theVar) {
            var elem = elemId('var-' + theVar.abbr);
            // clear the warning spot
            elemId('var-note-' + theVar.abbr).innerHTML = '';
            if (elem) {
                var value = elem.value;
                if (value) {
                    value = parseFloat(value);
                    if (!isNaN(value)) {
                        // okay it's a parseable value.
                        // now check its range.
                        if (value < theVar.failMin || value > theVar.failMax) {
                            // outside of the non-fail range.. fail out.
                            elemId('var-note-' + theVar.abbr).innerHTML = theVar.failMsg;
                            valuesOkay = false;
                        } else {
                            // inside the non-fail range.
                            if (value < theVar.warnMin || value > theVar.warnMax) {
                                // outside the tested range..
                                elemId('var-note-' + theVar.abbr).innerHTML = theVar.warnMsg;
                            }
                            varValues[theVar.abbr] = value;
                        }
                    }
                } else { valuesOkay = false }
            } else { valuesOkay = false }
        });

        if (valuesOkay) return varValues;
        return null;

    }
    // --------------------------------------------------------------
    var calculate = function() {

        output.innerHTML = '';

        var varValues = getInputs();

        // data.calcs = data.calcs.slice(0,1);

        if (!varValues) {
            output.innerHTML += '<p>Input values not valid.</p>';
        } else {
            data.calcs.forEach( function(calc) {

                if (calc.terms.length != calc.coefficients.length) {
                    output.innerHTML += '<p>' + calc.name + ' has mismatched terms and coefficients.</p>';
                } else {
                    // we'll loop downward through the terms
                    var term = calc.terms.length;
                    // ..and sum them into this var.
                    var sum = 0;

                    // loop through the terms, working each one out and adding them up
                    while (term--) {
                        // loop through vars replace each one in the expression
                        var expression = calc.terms[term];
                        data.vars.forEach( function(theVar) {
                            expression = expression.replace(theVar.abbr, '('+ varValues[theVar.abbr] +')');
                        });
                        // now evaluate the expression and multiply by the coefficient
                        var thisTerm = calc.coefficients[term] * eval(expression);
                        console.log(calc.terms[term] + '   ->    ' + expression + '    ->    * ' + calc.coefficients[term] + '   =>   ' + thisTerm);
                        sum += thisTerm;
                    }

                    // apply the rounding and capping
                    var sumStr = sum.toFixed(calc.rounding);
                    if (calc.lowcap && sum < calc.lowcap) {
                        sumStr = '< ' + calc.lowcap;
                    } else if (calc.highcap && sum > calc.highcap) {
                        sumStr = '> ' + calc.highcap;
                    }
                    output.innerHTML += '<p>' + calc.name + ': ' + sumStr + ' ' + calc.units + '</p>';

                    // debug: show terms and coefficients.
                    var table = '<div class="debug hide" id="info-' + calc.abbr + '">';
                    table += '<button onclick="elemId(\'info-' + calc.abbr + '\').className = \'debug show\';">info</button><table>';
                    table += '<tr><td colspan="2">Actual: ' + sum + '</td></tr>';
                    table += '<tr><th>Term</th><th>Coefficient</th></tr>';
                    for (var t = 0; t < calc.terms.length; t++) {
                        table += '<tr><td>' + calc.terms[t] + '</td><td>' + calc.coefficients[t].toExponential(3) + '</td></tr>';
                    }
                    table += '</table>';
                    output.innerHTML += table;
                }

            });
        }
    }
    // --------------------------------------------------------------

    buildForm();

</script>
</body>
</html>
